<!-- Import Polymer -->
<link rel="import" href="../../bower_components/polymer/polymer.html" />

<!-- Import style modules -->
<link rel="import" href="../../css/superbooth-frontend-styles.html" />
<link rel="import" href="../../bower_components/px-theme/px-theme-styles.html" />

<!-- Import external dependencies -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html" />
<link rel="import" href="../../bower_components/app-route/app-route.html" />
<link rel="import" href="../../bower_components/app-route/app-location.html" />
<link rel="import" href="../../bower_components/px-spinner/px-spinner.html" />
<link rel="import" href="../../bower_components/mqtt-elements/mqtt-elements.html">

<!-- Import internal dependencies -->
<link rel="import" href="../superbooth-header/superbooth-header.html" />
<link rel="import" href="../superbooth-competition-card/superbooth-competition-card.html" />

<dom-module id="superbooth-app">
  <template>
    <style include="predix-ui-styles" is="custom-style"></style>
    <style include="superbooth-frontend-styles" is="custom-style"></style>

    <!-- Config AJAX call -->
    <iron-ajax
        auto
        url="../../config.json"
        last-response="{{config}}"
        on-response="configLoaded">
    </iron-ajax>

    <!-- MQTT connector -->
    <mqtt-connection
        id="broker"
        connected="{{brokerConnected}}">
      <mqtt-subscription
          id="subscriber"
          number-of-messages="100"
          last-message="{{lastDataStorageMsg}}"
          messages="{{messages}}"
          subscribed="{{subscribed}}">
      </mqtt-subscription>
    </mqtt-connection>

    <!-- App -->
    <section class="superbooth flex flex--col flex--spaced">
      <!-- Header -->
      <superbooth-header class="flex__item" app-name="{{config.appName}}"></superbooth-header>

      <!-- Body -->
      <div class="flex__item">
        <div class="superbooth__body">
          <!-- App -->
          <section class="flex flex--col">
            <template is="dom-repeat" items="{{teams}}">
              <superbooth-competition-card
                  card-name={{item.teamName}}
                  scores={{item.data}}>
              </superbooth-competition-card>
            </template>
          </section>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex__item flex">
        <div class="superbooth__footer flex__item flex">
          <button class="btn btn--reverse flex__item--bottom flex__item--end" on-tap="_resetAllValues">Reset</button>
        </div>
      </div>
    </section>

  </template>
  <script>
    Polymer({
      is: 'superbooth-app',

      properties: {
        /**
         * When the initial AJAX call to retrieve state information is satisfied,
         * set to true to kick off display UI in the app.
         */
        initialStateLoaded: {
          type: Boolean,
          value: false
        },

        /**
         * Holds the last incoming message from the `DataStorageOut` topic.
         */
        lastDataStorageMsg: {
          type: Object,
          observer: '_handleDataStorageMsg'
        },

        teamLookup: {
          type: Object,
          value: function() { return {}; }
        },

        deptLookup: {
          type: Object,
          value: function() { return {}; }
        },

        teams: {
          type: Array,
          value: function() { return []; }
        },

        config: {
          type: Object
        }
      },

      observers: ['_calculateTeamLookup(teams)'],

      _calculateTeamLookup: function(teams) {
        if (teams && teams.length) {
          for (var i = 0; i < teams.length; i++) {
            var senderId = teams[i].senderId;
            var pathTo = 'teamLookup.' + senderId;
            if (typeof this.get(pathTo) === 'undefined') {
              this.set(pathTo, '#' + i);
            }
          }
        }
      },

      attached: function() {
        // this._ensureBrokerConnected();
      },

      /**
       * Checks the MQTT broker to make sure it is connected. Attempts to connect
       * if it is not connected.
       */
      _ensureBrokerConnected: function() {
        var broker = this.$.broker;
        if (broker) {
          broker.connect();
        }
      },

      _handleDataStorageMsg: function(msg) {
        if (!msg.parsedPayload) return;

        // Try to parse the message
        var parsedMsg;
        try {
          parsedMsg = JSON.parse(msg.parsedPayload);
        }
        catch (err) {
          console.log("Couldn't parse messge:" + err);
          return;
        }

        // 102 = Engineering
        // 104 = Production
        // 106 = Sales

        // Find the team for this sender
        var teamIndex = this.get('teamLookup.' + parsedMsg.Sender);
        if (typeof teamIndex === 'undefined') return;
        var pathToTeam = 'teams.' + teamIndex;
        var teamToInc = this.get(pathToTeam);

        if (teamToInc) {
          // var amountToInc = parsedMsg.Value;
          var amountToInc = 1;
          // var deptToInc = (parsedMsg.Notes.indexOf('Output') === -1) ? parsedMsg.Notes : parsedMsg.Notes.replace('Output', '');
          // var deptToInc;
          // if (parsedMsg.Name == "102") deptToInc = "Engineering";
          // if (parsedMsg.Name == "104") deptToInc = "Production";
          // if (parsedMsg.Name == "106") deptToInc = "Sales";
          var deptToInc = this.get('deptLookup.' + parsedMsg.Name);
          if (!deptToInc) {
            console.log("Unknown group "  + parsedMsg.Name + " for sender" + teamToInc.teamName);
          }
          var pathToDeptVal = this._ensureDept(pathToTeam, deptToInc);
          var newDeptVal = Math.floor(Math.floor(this.get(pathToDeptVal)) + Math.floor(amountToInc));
          this.set(pathToDeptVal, newDeptVal);
          console.log(
            'Updating data:' +
            '\n  Team: ' + teamToInc.teamName +
            '\n  Dept: ' + deptToInc +
            '\n  Amount to add: ' + amountToInc +
            '\n  New value: ' + newDeptVal
          );
        }
      },

      _ensureDept: function(teamPath, deptName) {
        var teamData = this.get(teamPath + '.data');
        var deptIndex;
        teamData.forEach(function(data, index) {
          if (data.name === deptName) {
            deptIndex = index;
          }
        });
        if (typeof deptIndex === 'undefined') {
          teamData.push({"name":deptName,"value":0});
          this.set(teamPath + '.data', teamData);
          deptIndex = (teamData.length - 1);
        }
        return teamPath + '.data.#' + deptIndex + '.value';
      },

      configLoaded: function(evt) {
        var config = evt.detail.response;

        // Resulting object:
        //
        // [
        //   { "senderId" : "-16711936",
        //     "teamName" : "Team 1",
        //     "data" : [ {name:"Engineering", value:0},{name:"Production", value:0},{name:"Sales", value:0} ] },
        //   { "senderId" : "-16711937",
        //     "teamName" : "Team 2",
        //     "data" : [ {name:"Engineering", value:0},{name:"Production", value:0},{name:"Sales", value:0} ] },
        // ]
        var teams = [];

        // Create first team
        teams.push({
          teamName: config.team1.name,
          senderId: config.team1.sender,
          data: [
            { name: config.group1.name, value: 0 },
            { name: config.group2.name, value: 0 },
            { name: config.group3.name, value: 0 }
          ]
        });

        // Create second team
        teams.push({
          teamName: config.team2.name,
          senderId: config.team2.sender,
          data: [
            { name: config.group1.name, value: 0 },
            { name: config.group2.name, value: 0 },
            { name: config.group3.name, value: 0 }
          ]
        });

        // Create deptLookup
        this.set('deptLookup.' + config.group1.id, config.group1.name);
        this.set('deptLookup.' + config.group2.id, config.group2.name);
        this.set('deptLookup.' + config.group3.id, config.group3.name);

        // Set the teams
        this.set('teams', teams);

        // Configure broker
        this.$.broker.set('url', config.mqttWebsocketUrl);
        if (config.mqttRequiresLogin && config.mqttUsername && config.mqttPassword) {
          this.$.broker.set('withCredentials', true);
          this.$.broker.set('options', { username: config.mqttUsername, password: config.mqttPassword });
        }
        this.$.broker.set('auto', true);

        // Configure subscriber
        this.$.subscriber.set('topic', config.mqttTopic);

        // Make sure broker connects
        this._ensureBrokerConnected();
      },

      _resetAllValues: function() {
        var teams = this.get('teams');
        if (!teams || !teams.length) return;
        var dataPathsToClear = [];
        teams.forEach(function(team, index) {
          var basePath = 'teams.#' + index + '.data';
          var dataArrs = this.get(basePath);
          for (var i = 0; i < dataArrs.length; i++) {
            dataPathsToClear.push(basePath + '.#' + i + '.value');
          }
        }.bind(this));

        // Clear each path
        dataPathsToClear.forEach(function(path) {
          this.set(path, 0);
        }.bind(this));
      }

    });
  </script>
</dom-module>
